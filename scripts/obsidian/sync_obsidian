#!/usr/bin/env bash

# Only one process 
LOCKFILE="/tmp/sync_obsidian.lock"
# ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÑƒ, Ð¸Ð½Ð°Ñ‡Ðµ Ð²Ñ‹Ð¹Ñ‚Ð¸
exec 9>"$LOCKFILE"
if ! flock -n 9; then
  notify-send -u low -t 5000 "â³ Sync already running" "Another sync_obsidian is still in progress."
  exit 1
fi

# ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
LOCAL_DIR="$HOME/obsidian/vault_zhenyapaitash"
REMOTE_NAME="yadisk"
REMOTE_DIR="obsidian/vault_zhenyapaitash"
LOG_FILE="$HOME/.cache/rclone/yadisk_sync.log"
MODE="$1"

if [[ -z "$MODE" ]]; then
  echo "Usage: sync_yadisk {sync|copy|check|bisync|syncasync}"
  exit 1
fi

run_sync() {
  START_TIME=$(date '+%Y-%m-%d %H:%M:%S')
  echo "[$START_TIME] Starting rclone $1..." >> "$LOG_FILE"

  case "$1" in
    sync)
      rclone sync "$LOCAL_DIR" "$REMOTE_NAME:$REMOTE_DIR" \
        --log-file "$LOG_FILE" --log-level INFO --progress \
        --size-only --fast-list
      ;;
    copy)
      rclone copy "$LOCAL_DIR" "$REMOTE_NAME:$REMOTE_DIR" \
        --log-file "$LOG_FILE" --log-level INFO --progress
      ;;
    check)
      rclone check "$LOCAL_DIR" "$REMOTE_NAME:$REMOTE_DIR" \
        --one-way --log-file "$LOG_FILE" --log-level INFO
      ;;
    bisync)
      rclone bisync "$LOCAL_DIR" "$REMOTE_NAME:$REMOTE_DIR" \
        --log-file "$LOG_FILE" --log-level INFO
      ;;
    *)
      echo "Unknown mode: $1"
      return 1
      ;;
  esac

  STATUS=$?
  END_TIME=$(date '+%Y-%m-%d %H:%M:%S')

  if [ $STATUS -eq 0 ]; then
    echo "[$END_TIME] âœ… rclone $1 completed successfully." >> "$LOG_FILE"
    notify-send -t 60000 "ðŸŸ¢ Obsidian $1 (async)" "âœ… Completed at $END_TIME"
  else
    echo "[$END_TIME] âŒ rclone $1 failed with code $STATUS." >> "$LOG_FILE"
    notify-send -u critical -t 0 "ðŸ”´ Obsidian $1 FAILED" "âŒ Exit code: $STATUS\n$END_TIME"
  fi

  return $STATUS
}

case "$MODE" in
  sync|copy|check|bisync)
    run_sync "$MODE"
    ;;
  syncasync)
    (
      run_sync "sync"
    ) >/dev/null 2>&1 &
    disown
    echo "Started async sync in background"
    ;;
  *)
    echo "Unknown mode: $MODE"
    echo "Usage: sync_yadisk {sync|copy|check|bisync|syncasync}"
    exit 1
    ;;
esac

